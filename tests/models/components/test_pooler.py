import pytest
import torch
from torch.nn import Module

from pie_models.models.components.pooler import (
    CLS_TOKEN,
    MENTION_POOLING,
    START_TOKENS,
    ArgumentWrappedPooler,
    AtIndexPooler,
    SpanMaxPooler,
    get_pooler_and_output_size,
    pool_cls,
)


@pytest.mark.parametrize(
    "pooler_type",
    [
        CLS_TOKEN,
        START_TOKENS,
        MENTION_POOLING,
    ],
)
def test_get_pooler_and_output_size(pooler_type):
    pooler, output_size = get_pooler_and_output_size(config={"type": pooler_type}, input_dim=20)
    assert pooler is not None
    if pooler_type == CLS_TOKEN:
        assert output_size == 20
    elif pooler_type in (START_TOKENS, MENTION_POOLING):
        # pre default, num_indices is 2
        assert output_size == 20 * 2
    else:
        raise ValueError(f"Unknown pooler type {pooler_type}")


@pytest.fixture(scope="session")
def inputs():
    start_indices = torch.tensor(
        [[2, 10], [5, 13], [5, 17], [17, 11], [5, 13], [14, 18], [18, 14]]
    )
    end_indices = torch.tensor([[6, 11], [9, 14], [9, 18], [18, 12], [9, 14], [15, 19], [19, 15]])
    assert start_indices.shape == end_indices.shape == (7, 2)
    hidden_state = torch.tensor(
        [
            [
                [
                    0.8822692632675171,
                    0.9150039553642273,
                    0.38286375999450684,
                    0.9593056440353394,
                    0.3904482126235962,
                    0.600895345211029,
                    0.2565724849700928,
                    0.7936413288116455,
                    0.9407714605331421,
                    0.13318592309951782,
                ],
                [
                    0.9345980882644653,
                    0.5935796499252319,
                    0.8694044351577759,
                    0.5677152872085571,
                    0.7410940527915955,
                    0.42940449714660645,
                    0.8854429125785828,
                    0.5739044547080994,
                    0.2665800452232361,
                    0.6274491548538208,
                ],
                [
                    0.26963168382644653,
                    0.4413635730743408,
                    0.2969208359718323,
                    0.831685483455658,
                    0.10531491041183472,
                    0.26949483156204224,
                    0.3588126301765442,
                    0.19936376810073853,
                    0.5471915602684021,
                    0.006160438060760498,
                ],
                [
                    0.951554536819458,
                    0.07526588439941406,
                    0.8860136866569519,
                    0.5832095742225647,
                    0.3376477360725403,
                    0.8089749813079834,
                    0.5779253840446472,
                    0.9039816856384277,
                    0.5546598434448242,
                    0.34231340885162354,
                ],
                [
                    0.634341835975647,
                    0.36441028118133545,
                    0.710428774356842,
                    0.9464110732078552,
                    0.7890297770500183,
                    0.281413733959198,
                    0.788632333278656,
                    0.5894631147384644,
                    0.7539175152778625,
                    0.19524747133255005,
                ],
                [
                    0.005045771598815918,
                    0.30681973695755005,
                    0.11648857593536377,
                    0.9102694392204285,
                    0.6440156698226929,
                    0.7071067690849304,
                    0.6581305861473083,
                    0.4913020133972168,
                    0.8913041353225708,
                    0.1447432041168213,
                ],
                [
                    0.5314818620681763,
                    0.1587299108505249,
                    0.6541759967803955,
                    0.32780885696411133,
                    0.6532081365585327,
                    0.3958292603492737,
                    0.9146959185600281,
                    0.20364904403686523,
                    0.20180100202560425,
                    0.20178300142288208,
                ],
                [
                    0.9497213959693909,
                    0.6666255593299866,
                    0.9811253547668457,
                    0.08736187219619751,
                    0.00406193733215332,
                    0.10881811380386353,
                    0.16365545988082886,
                    0.7025200724601746,
                    0.6790379285812378,
                    0.9154621958732605,
                ],
                [
                    0.24178731441497803,
                    0.1591441035270691,
                    0.7652890682220459,
                    0.2978977560997009,
                    0.8034619092941284,
                    0.38134968280792236,
                    0.786022961139679,
                    0.11151599884033203,
                    0.2476751208305359,
                    0.652438223361969,
                ],
                [
                    0.6057037711143494,
                    0.3725206255912781,
                    0.7980347275733948,
                    0.8399046063423157,
                    0.13741332292556763,
                    0.2330659031867981,
                    0.9578309655189514,
                    0.3312837481498718,
                    0.3227418065071106,
                    0.016202688217163086,
                ],
                [
                    0.21366488933563232,
                    0.6249018311500549,
                    0.43400341272354126,
                    0.13705700635910034,
                    0.5117283463478088,
                    0.15845924615859985,
                    0.07580167055130005,
                    0.2246686816215515,
                    0.06239396333694458,
                    0.1816309690475464,
                ],
                [
                    0.9998044371604919,
                    0.5944374799728394,
                    0.6540798544883728,
                    0.033657848834991455,
                    0.17161309719085693,
                    0.3335720896720886,
                    0.5781855583190918,
                    0.06003934144973755,
                    0.28456348180770874,
                    0.20066571235656738,
                ],
                [
                    0.5013856291770935,
                    0.313948392868042,
                    0.4653521180152893,
                    0.1611851453781128,
                    0.15680241584777832,
                    0.20829910039901733,
                    0.32885128259658813,
                    0.10535955429077148,
                    0.9192349314689636,
                    0.400767982006073,
                ],
                [
                    0.9301983714103699,
                    0.6557910442352295,
                    0.07660150527954102,
                    0.846017599105835,
                    0.36242759227752686,
                    0.3083369731903076,
                    0.08496475219726562,
                    0.0029196739196777344,
                    0.6430553197860718,
                    0.3907780647277832,
                ],
                [
                    0.694661557674408,
                    0.08966827392578125,
                    0.8712145686149597,
                    0.13297313451766968,
                    0.4136633276939392,
                    0.6044348478317261,
                    0.758125901222229,
                    0.9036551713943481,
                    0.955479621887207,
                    0.10353893041610718,
                ],
                [
                    0.6258336305618286,
                    0.2849370241165161,
                    0.4452075958251953,
                    0.1257549524307251,
                    0.9554293155670166,
                    0.13302475214004517,
                    0.7672256231307983,
                    0.6757197976112366,
                    0.662477970123291,
                    0.22967690229415894,
                ],
                [
                    0.9544757604598999,
                    0.6098752021789551,
                    0.5643200278282166,
                    0.05937260389328003,
                    0.7098942399024963,
                    0.4249897003173828,
                    0.27093786001205444,
                    0.9294732809066772,
                    0.6114743947982788,
                    0.2233617901802063,
                ],
                [
                    0.2469305396080017,
                    0.4761221408843994,
                    0.779180645942688,
                    0.3722330927848816,
                    0.21471256017684937,
                    0.32877856492996216,
                    0.12646257877349854,
                    0.6783162355422974,
                    0.8870201110839844,
                    0.02927982807159424,
                ],
                [
                    0.6161253452301025,
                    0.7582958936691284,
                    0.5906646847724915,
                    0.3219376802444458,
                    0.7609710693359375,
                    0.7627565860748291,
                    0.6869636178016663,
                    0.41213929653167725,
                    0.36759936809539795,
                    0.5534904599189758,
                ],
                [
                    0.4116729497909546,
                    0.35099947452545166,
                    0.819603443145752,
                    0.9296997785568237,
                    0.45050132274627686,
                    0.3880515694618225,
                    0.5072961449623108,
                    0.4701458811759949,
                    0.6202056407928467,
                    0.640116810798645,
                ],
                [
                    0.045871615409851074,
                    0.31548112630844116,
                    0.9210647344589233,
                    0.6947774887084961,
                    0.47513121366500854,
                    0.1985471248626709,
                    0.19409745931625366,
                    0.052116572856903076,
                    0.33701878786087036,
                    0.6688520908355713,
                ],
                [
                    0.8188108205795288,
                    0.7308486700057983,
                    0.05802798271179199,
                    0.1993187665939331,
                    0.4210916757583618,
                    0.9836747646331787,
                    0.5723287463188171,
                    0.3705146312713623,
                    0.7068576216697693,
                    0.3095592260360718,
                ],
            ],
            [
                [
                    0.17637217044830322,
                    0.8649436235427856,
                    0.2726491093635559,
                    0.39976662397384644,
                    0.0025978684425354004,
                    0.834635317325592,
                    0.8788173198699951,
                    0.6822240948677063,
                    0.15136289596557617,
                    0.006530046463012695,
                ],
                [
                    0.09391051530838013,
                    0.8728501200675964,
                    0.7400528788566589,
                    0.920752227306366,
                    0.7619349360466003,
                    0.6265460848808289,
                    0.495103657245636,
                    0.11974698305130005,
                    0.07161390781402588,
                    0.032325685024261475,
                ],
                [
                    0.7046809792518616,
                    0.25451600551605225,
                    0.39937371015548706,
                    0.21224737167358398,
                    0.40888822078704834,
                    0.14808255434036255,
                    0.1732921600341797,
                    0.6658554077148438,
                    0.35140180587768555,
                    0.8086715936660767,
                ],
                [
                    0.33959561586380005,
                    0.13321638107299805,
                    0.41178053617477417,
                    0.2576262950897217,
                    0.3470292091369629,
                    0.02400219440460205,
                    0.7797454595565796,
                    0.15189772844314575,
                    0.7513088583946228,
                    0.7268921136856079,
                ],
                [
                    0.8572163581848145,
                    0.1164739727973938,
                    0.8595983982086182,
                    0.2636241912841797,
                    0.6855345964431763,
                    0.9695573449134827,
                    0.4294840693473816,
                    0.4961332678794861,
                    0.38488471508026123,
                    0.08250772953033447,
                ],
                [
                    0.7399514317512512,
                    0.003641068935394287,
                    0.8103999495506287,
                    0.8741125464439392,
                    0.9728531837463379,
                    0.3820602297782898,
                    0.08917903900146484,
                    0.6124151349067688,
                    0.7762136459350586,
                    0.0023456215858459473,
                ],
                [
                    0.38650816679000854,
                    0.20027226209640503,
                    0.4562681317329407,
                    0.25389325618743896,
                    0.2956162095069885,
                    0.3412705659866333,
                    0.024847984313964844,
                    0.9102537631988525,
                    0.9191656112670898,
                    0.4215654730796814,
                ],
                [
                    0.44305896759033203,
                    0.2959400415420532,
                    0.048468589782714844,
                    0.013427793979644775,
                    0.685829222202301,
                    0.2254769206047058,
                    0.1785615086555481,
                    0.4609884023666382,
                    0.3334944248199463,
                    0.3382396101951599,
                ],
                [
                    0.5160655975341797,
                    0.39394378662109375,
                    0.3278437852859497,
                    0.2605970501899719,
                    0.09308630228042603,
                    0.9192535877227783,
                    0.2999064326286316,
                    0.6324897408485413,
                    0.3265170454978943,
                    0.5406306385993958,
                ],
                [
                    0.9661502242088318,
                    0.7303613424301147,
                    0.06670016050338745,
                    0.6984513998031616,
                    0.9746214151382446,
                    0.6315416693687439,
                    0.8352123498916626,
                    0.9929437637329102,
                    0.42338550090789795,
                    0.6037772297859192,
                ],
                [
                    0.15248245000839233,
                    0.3969614505767822,
                    0.8702918887138367,
                    0.7563229203224182,
                    0.18360549211502075,
                    0.09905749559402466,
                    0.1583181619644165,
                    0.006561160087585449,
                    0.11418050527572632,
                    0.3763512969017029,
                ],
                [
                    0.8374385833740234,
                    0.5836911201477051,
                    0.11969727277755737,
                    0.09888803958892822,
                    0.748737633228302,
                    0.128079354763031,
                    0.43843626976013184,
                    0.739853024482727,
                    0.268593966960907,
                    0.4454800486564636,
                ],
                [
                    0.4564777612686157,
                    0.3817083239555359,
                    0.2464839220046997,
                    0.05428081750869751,
                    0.09582149982452393,
                    0.23226916790008545,
                    0.9829188585281372,
                    0.258492648601532,
                    0.16423600912094116,
                    0.6211971044540405,
                ],
                [
                    0.637805163860321,
                    0.7739548683166504,
                    0.8800601959228516,
                    0.778437077999115,
                    0.004249513149261475,
                    0.5443443059921265,
                    0.8028765320777893,
                    0.45378726720809937,
                    0.20536041259765625,
                    0.9766699075698853,
                ],
                [
                    0.3129860758781433,
                    0.21532773971557617,
                    0.049222469329833984,
                    0.5223341584205627,
                    0.7215665578842163,
                    0.610681414604187,
                    0.5988748669624329,
                    0.12080627679824829,
                    0.03305637836456299,
                    0.5088046789169312,
                ],
                [
                    0.9559170603752136,
                    0.7884606719017029,
                    0.2088828682899475,
                    0.43509572744369507,
                    0.1314082145690918,
                    0.2587882876396179,
                    0.5905491709709167,
                    0.7722692489624023,
                    0.9141846299171448,
                    0.04094696044921875,
                ],
                [
                    0.8343076109886169,
                    0.14735394716262817,
                    0.6872336268424988,
                    0.9231226444244385,
                    0.5070211887359619,
                    0.9549044966697693,
                    0.07397425174713135,
                    0.30902040004730225,
                    0.7916264533996582,
                    0.3910660743713379,
                ],
                [
                    0.397649884223938,
                    0.2916041612625122,
                    0.8446530699729919,
                    0.7452515959739685,
                    0.6602250337600708,
                    0.21901816129684448,
                    0.09412521123886108,
                    0.5540803074836731,
                    0.6481394171714783,
                    0.26914405822753906,
                ],
                [
                    0.3601011633872986,
                    0.8376838564872742,
                    0.5398298501968384,
                    0.5225591659545898,
                    0.3769497275352478,
                    0.04720515012741089,
                    0.02987128496170044,
                    0.26099246740341187,
                    0.24583929777145386,
                    0.6557767987251282,
                ],
                [
                    0.35444462299346924,
                    0.30438894033432007,
                    0.9767149090766907,
                    0.674161434173584,
                    0.856451153755188,
                    0.25794363021850586,
                    0.29576659202575684,
                    0.6837702393531799,
                    0.16686242818832397,
                    0.17314797639846802,
                ],
                [
                    0.4758501648902893,
                    0.31711965799331665,
                    0.1251710057258606,
                    0.7965794801712036,
                    0.9020814299583435,
                    0.5811116695404053,
                    0.41294336318969727,
                    0.036863505840301514,
                    0.31788063049316406,
                    0.627292811870575,
                ],
                [
                    0.7357654571533203,
                    0.43679124116897583,
                    0.302323579788208,
                    0.7786130309104919,
                    0.10180014371871948,
                    0.816008985042572,
                    0.306022584438324,
                    0.5076526999473572,
                    0.4011920690536499,
                    0.5606194734573364,
                ],
            ],
            [
                [
                    0.34890079498291016,
                    0.8635634779930115,
                    0.4870014190673828,
                    0.8902997374534607,
                    0.9807402491569519,
                    0.2564045190811157,
                    0.1352454423904419,
                    0.9011510014533997,
                    0.891806960105896,
                    0.11822634935379028,
                ],
                [
                    0.46134835481643677,
                    0.006936848163604736,
                    0.09070044755935669,
                    0.5965712666511536,
                    0.6330173015594482,
                    0.6059905290603638,
                    0.36391764879226685,
                    0.9612888693809509,
                    0.5714889764785767,
                    0.20495760440826416,
                ],
                [
                    0.47169309854507446,
                    0.620072603225708,
                    0.675096333026886,
                    0.14645957946777344,
                    0.6873947978019714,
                    0.2445591688156128,
                    0.0845298171043396,
                    0.2268962860107422,
                    0.9822046756744385,
                    0.9274289011955261,
                ],
                [
                    0.947742223739624,
                    0.7935056090354919,
                    0.8777247667312622,
                    0.4330751299858093,
                    0.22488605976104736,
                    0.7498282790184021,
                    0.24090862274169922,
                    0.16256707906723022,
                    0.3403329849243164,
                    0.6049296259880066,
                ],
                [
                    0.7573983073234558,
                    0.30579549074172974,
                    0.20571684837341309,
                    0.5674465298652649,
                    0.20528340339660645,
                    0.17446929216384888,
                    0.760625958442688,
                    0.4160076975822449,
                    0.9568924903869629,
                    0.9863913059234619,
                ],
                [
                    0.6495527625083923,
                    0.6720788478851318,
                    0.6151418685913086,
                    0.5078304409980774,
                    0.46363377571105957,
                    0.5068720579147339,
                    0.686712384223938,
                    0.964885413646698,
                    0.3704204559326172,
                    0.28864210844039917,
                ],
                [
                    0.3789175748825073,
                    0.2584378719329834,
                    0.5850193500518799,
                    0.8732241988182068,
                    0.8909887075424194,
                    0.7295627593994141,
                    0.13203424215316772,
                    0.23164761066436768,
                    0.3901442885398865,
                    0.4078379273414612,
                ],
                [
                    0.5411238670349121,
                    0.041014254093170166,
                    0.6556223630905151,
                    0.1185639500617981,
                    0.1836276650428772,
                    0.08430874347686768,
                    0.9356598258018494,
                    0.026530086994171143,
                    0.8771833777427673,
                    0.4831915497779846,
                ],
                [
                    0.44185060262680054,
                    0.8127392530441284,
                    0.4537861943244934,
                    0.8135770559310913,
                    0.8615074753761292,
                    0.0658949613571167,
                    0.6923919916152954,
                    0.5943894982337952,
                    0.6075058579444885,
                    0.5729957222938538,
                ],
                [
                    0.6367654800415039,
                    0.25946658849716187,
                    0.43602943420410156,
                    0.975059986114502,
                    0.8359247446060181,
                    0.48121577501296997,
                    0.029734551906585693,
                    0.5219138860702515,
                    0.15951323509216309,
                    0.906595766544342,
                ],
                [
                    0.19645631313323975,
                    0.4638991951942444,
                    0.3890286684036255,
                    0.5889769196510315,
                    0.9705138206481934,
                    0.5475096106529236,
                    0.7895820140838623,
                    0.8881108164787292,
                    0.9036555886268616,
                    0.3273242712020874,
                ],
                [
                    0.3881716728210449,
                    0.7409688830375671,
                    0.36356616020202637,
                    0.7341319918632507,
                    0.3907661437988281,
                    0.16087383031845093,
                    0.7035216689109802,
                    0.5766590237617493,
                    0.7229241728782654,
                    0.9967430233955383,
                ],
                [
                    0.8413664698600769,
                    0.9739905595779419,
                    0.5267614126205444,
                    0.0698937177658081,
                    0.14923638105392456,
                    0.1894131302833557,
                    0.0593758225440979,
                    0.24937623739242554,
                    0.039716124534606934,
                    0.038692355155944824,
                ],
                [
                    0.2012227177619934,
                    0.0070830583572387695,
                    0.19309377670288086,
                    0.6906543374061584,
                    0.9170264005661011,
                    0.35126858949661255,
                    0.35456061363220215,
                    0.7669766545295715,
                    0.2533145546913147,
                    0.2635837197303772,
                ],
                [
                    0.8080647587776184,
                    0.06434917449951172,
                    0.5611373782157898,
                    0.941690981388092,
                    0.585743248462677,
                    0.6359719038009644,
                    0.2088044285774231,
                    0.49310171604156494,
                    0.5274922251701355,
                    0.6227171421051025,
                ],
                [
                    0.6942729949951172,
                    0.9344639182090759,
                    0.11835026741027832,
                    0.5149876475334167,
                    0.2501818537712097,
                    0.10446804761886597,
                    0.4599611759185791,
                    0.05988156795501709,
                    0.8489496111869812,
                    0.5579074025154114,
                ],
                [
                    0.23052096366882324,
                    0.7612895369529724,
                    0.02678602933883667,
                    0.3066003918647766,
                    0.40259063243865967,
                    0.07512485980987549,
                    0.18205583095550537,
                    0.418390691280365,
                    0.879382312297821,
                    0.9828271269798279,
                ],
                [
                    0.8181312084197998,
                    0.20143800973892212,
                    0.17288941144943237,
                    0.9363465905189514,
                    0.6768587231636047,
                    0.5132838487625122,
                    0.5676660537719727,
                    0.09815162420272827,
                    0.3330572843551636,
                    0.9813090562820435,
                ],
                [
                    0.37668389081954956,
                    0.4749179482460022,
                    0.08483445644378662,
                    0.2202964425086975,
                    0.4897902011871338,
                    0.18942028284072876,
                    0.43799519538879395,
                    0.7034795880317688,
                    0.010911345481872559,
                    0.6485060453414917,
                ],
                [
                    0.16939592361450195,
                    0.2559744715690613,
                    0.6919548511505127,
                    0.8975601196289062,
                    0.3633456826210022,
                    0.2947154641151428,
                    0.047882080078125,
                    0.24217116832733154,
                    0.06218153238296509,
                    0.38556474447250366,
                ],
                [
                    0.6020277142524719,
                    0.03156214952468872,
                    0.9365567564964294,
                    0.8136954307556152,
                    0.010527074337005615,
                    0.261183500289917,
                    0.6630775928497314,
                    0.39727020263671875,
                    0.44551175832748413,
                    0.2742421627044678,
                ],
                [
                    0.9016097784042358,
                    0.2205008864402771,
                    0.9146384000778198,
                    0.5322611331939697,
                    0.6005108952522278,
                    0.8900659084320068,
                    0.41761720180511475,
                    0.21532833576202393,
                    0.41913288831710815,
                    0.9055266976356506,
                ],
            ],
            [
                [
                    0.12900632619857788,
                    0.6134902238845825,
                    0.008604288101196289,
                    0.7621510624885559,
                    0.6847338676452637,
                    0.5211961269378662,
                    0.7145965695381165,
                    0.5005623698234558,
                    0.7766764163970947,
                    0.10418975353240967,
                ],
                [
                    0.4265737533569336,
                    0.7218073010444641,
                    0.9979084134101868,
                    0.75469571352005,
                    0.13641279935836792,
                    0.8845484256744385,
                    0.3885008692741394,
                    0.3932427763938904,
                    0.04554516077041626,
                    0.42129284143447876,
                ],
                [
                    0.8536633849143982,
                    0.5697224140167236,
                    0.20877301692962646,
                    0.6539060473442078,
                    0.3396778106689453,
                    0.9564970135688782,
                    0.06602269411087036,
                    0.34206223487854004,
                    0.01721322536468506,
                    0.3030849099159241,
                ],
                [
                    0.657623827457428,
                    0.981307327747345,
                    0.5839731693267822,
                    0.9901792407035828,
                    0.5978260636329651,
                    0.7887679934501648,
                    0.9008311033248901,
                    0.9179616570472717,
                    0.22013813257217407,
                    0.9596949815750122,
                ],
                [
                    0.802882730960846,
                    0.26621049642562866,
                    0.2613983154296875,
                    0.08062690496444702,
                    0.6255686283111572,
                    0.09472537040710449,
                    0.7112123370170593,
                    0.6578988432884216,
                    0.06559890508651733,
                    0.6362504363059998,
                ],
                [
                    0.45933473110198975,
                    0.7284088730812073,
                    0.7868947982788086,
                    0.0029274821281433105,
                    0.958549439907074,
                    0.9193210005760193,
                    0.6989418268203735,
                    0.04301947355270386,
                    0.3213896155357361,
                    0.3550955653190613,
                ],
                [
                    0.37150102853775024,
                    0.7819615602493286,
                    0.6817852854728699,
                    0.8960895538330078,
                    0.31273841857910156,
                    0.6682698726654053,
                    0.677897572517395,
                    0.08370459079742432,
                    0.014990091323852539,
                    0.24055546522140503,
                ],
                [
                    0.8422738313674927,
                    0.029270172119140625,
                    0.06478309631347656,
                    0.7801002860069275,
                    0.7697644829750061,
                    0.9111963510513306,
                    0.12253063917160034,
                    0.1340501308441162,
                    0.756493330001831,
                    0.9348151087760925,
                ],
                [
                    0.7991694211959839,
                    0.5783260464668274,
                    0.6647873520851135,
                    0.9745633602142334,
                    0.17739784717559814,
                    0.27299410104751587,
                    0.8497334718704224,
                    0.15788018703460693,
                    0.22429370880126953,
                    0.864995539188385,
                ],
                [
                    0.6577610373497009,
                    0.6615350246429443,
                    0.28807979822158813,
                    0.49309974908828735,
                    0.95761638879776,
                    0.19988995790481567,
                    0.5039311051368713,
                    0.7377997636795044,
                    0.15482187271118164,
                    0.9855884313583374,
                ],
                [
                    0.2501947283744812,
                    0.3799319863319397,
                    0.3647148609161377,
                    0.17417055368423462,
                    0.009367704391479492,
                    0.7819257974624634,
                    0.6328370571136475,
                    0.03169959783554077,
                    0.1781865954399109,
                    0.9941840171813965,
                ],
                [
                    0.691117525100708,
                    0.7006223201751709,
                    0.2008509635925293,
                    0.2808019518852234,
                    0.42452293634414673,
                    0.40856003761291504,
                    0.15737581253051758,
                    0.5411924719810486,
                    0.5496940016746521,
                    0.43668949604034424,
                ],
                [
                    0.5693159103393555,
                    0.301824688911438,
                    0.6301259398460388,
                    0.6885702013969421,
                    0.23663049936294556,
                    0.004210472106933594,
                    0.7617172002792358,
                    0.6192683577537537,
                    0.24570602178573608,
                    0.9818509817123413,
                ],
                [
                    0.27387601137161255,
                    0.8378733992576599,
                    0.7536642551422119,
                    0.08079594373703003,
                    0.8224706649780273,
                    0.04026353359222412,
                    0.2229926586151123,
                    0.41664254665374756,
                    0.16297674179077148,
                    0.9884549379348755,
                ],
                [
                    0.39971017837524414,
                    0.698594868183136,
                    0.053544044494628906,
                    0.7878332138061523,
                    0.3446081280708313,
                    0.11966437101364136,
                    0.5731114745140076,
                    0.7422308921813965,
                    0.9326985478401184,
                    0.19460368156433105,
                ],
                [
                    0.2539478540420532,
                    0.596131443977356,
                    0.6356306076049805,
                    0.6922361254692078,
                    0.7744376063346863,
                    0.3866231441497803,
                    0.7777848243713379,
                    0.8686457872390747,
                    0.36938923597335815,
                    0.8557286262512207,
                ],
                [
                    0.744289755821228,
                    0.9410263895988464,
                    0.21586304903030396,
                    0.25309550762176514,
                    0.355430543422699,
                    0.5253631472587585,
                    0.8000994920730591,
                    0.21456867456436157,
                    0.7503269910812378,
                    0.3208093047142029,
                ],
                [
                    0.8020546436309814,
                    0.4762613773345947,
                    0.06195652484893799,
                    0.22487705945968628,
                    0.1381239891052246,
                    0.7479812502861023,
                    0.1647258996963501,
                    0.4583408832550049,
                    0.6078779101371765,
                    0.22580265998840332,
                ],
                [
                    0.6442350149154663,
                    0.01178830862045288,
                    0.14224576950073242,
                    0.046938300132751465,
                    0.34876132011413574,
                    0.31785130500793457,
                    0.5715966820716858,
                    0.40754276514053345,
                    0.7350410223007202,
                    0.9583976864814758,
                ],
                [
                    0.6793955564498901,
                    0.3030162453651428,
                    0.03180718421936035,
                    0.6811009645462036,
                    0.25227105617523193,
                    0.7544381618499756,
                    0.8342424631118774,
                    0.6928602457046509,
                    0.9691553711891174,
                    0.9748982191085815,
                ],
                [
                    0.6058699488639832,
                    0.1356816291809082,
                    0.9467206597328186,
                    0.26275211572647095,
                    0.2638232111930847,
                    0.9183893203735352,
                    0.8874051570892334,
                    0.6510756611824036,
                    0.5313419103622437,
                    0.07941704988479614,
                ],
                [
                    0.44809794425964355,
                    0.9795631766319275,
                    0.627329409122467,
                    0.542809009552002,
                    0.39617449045181274,
                    0.32560884952545166,
                    0.7980113625526428,
                    0.5308342576026917,
                    0.8252871036529541,
                    0.4115006923675537,
                ],
            ],
            [
                [
                    0.7184545993804932,
                    0.7063849568367004,
                    0.5797320604324341,
                    0.8141865134239197,
                    0.8133229613304138,
                    0.9634616374969482,
                    0.8843879699707031,
                    0.3721516728401184,
                    0.07668989896774292,
                    0.5914087295532227,
                ],
                [
                    0.49563586711883545,
                    0.3695873022079468,
                    0.4162726402282715,
                    0.5235164165496826,
                    0.8648149371147156,
                    0.6558706164360046,
                    0.3224528431892395,
                    0.2943875193595886,
                    0.376184344291687,
                    0.30674850940704346,
                ],
                [
                    0.9496114253997803,
                    0.7648226618766785,
                    0.9514878392219543,
                    0.5015968084335327,
                    0.6008354425430298,
                    0.6733823418617249,
                    0.02672344446182251,
                    0.544648289680481,
                    0.46655499935150146,
                    0.21967297792434692,
                ],
                [
                    0.11202633380889893,
                    0.9426372051239014,
                    0.9065330028533936,
                    0.7317343354225159,
                    0.9771248698234558,
                    0.2970960736274719,
                    0.4136386513710022,
                    0.689309298992157,
                    0.4173867106437683,
                    0.4018825888633728,
                ],
                [
                    0.08671927452087402,
                    0.6343306303024292,
                    0.19783639907836914,
                    0.5181831121444702,
                    0.98748779296875,
                    0.3460923433303833,
                    0.3424041271209717,
                    0.8016564249992371,
                    0.31617337465286255,
                    0.4570612907409668,
                ],
                [
                    0.9668692350387573,
                    0.2950131297111511,
                    0.14229488372802734,
                    0.22017812728881836,
                    0.36137717962265015,
                    0.26275062561035156,
                    0.24053412675857544,
                    0.701972246170044,
                    0.5849688649177551,
                    0.3399692177772522,
                ],
                [
                    0.11154431104660034,
                    0.34257006645202637,
                    0.2889804244041443,
                    0.33729052543640137,
                    0.04893851280212402,
                    0.6077145338058472,
                    0.13263821601867676,
                    0.11060041189193726,
                    0.09148341417312622,
                    0.7086918354034424,
                ],
                [
                    0.19898664951324463,
                    0.2936245799064636,
                    0.8919203281402588,
                    0.7654821276664734,
                    0.7866955995559692,
                    0.025246739387512207,
                    0.14145010709762573,
                    0.31124448776245117,
                    0.9130488038063049,
                    0.5511502027511597,
                ],
                [
                    0.1260514259338379,
                    0.5031309127807617,
                    0.11166459321975708,
                    0.3904503583908081,
                    0.362512469291687,
                    0.932830810546875,
                    0.6548683643341064,
                    0.4128144383430481,
                    0.5844643712043762,
                    0.35566723346710205,
                ],
                [
                    0.6964501738548279,
                    0.6977819204330444,
                    0.6342730522155762,
                    0.30511152744293213,
                    0.9265753626823425,
                    0.4278150200843811,
                    0.3053416609764099,
                    0.8131570219993591,
                    0.9075283408164978,
                    0.9975798726081848,
                ],
                [
                    0.6481291651725769,
                    0.3295530676841736,
                    0.7539460062980652,
                    0.9289772510528564,
                    0.009582936763763428,
                    0.4380565285682678,
                    0.15901726484298706,
                    0.5931798815727234,
                    0.706792414188385,
                    0.3967060446739197,
                ],
                [
                    0.45817142724990845,
                    0.7250553965568542,
                    0.41596513986587524,
                    0.08011025190353394,
                    0.9000679850578308,
                    0.24834275245666504,
                    0.445070743560791,
                    0.547163188457489,
                    0.4699515700340271,
                    0.02965700626373291,
                ],
                [
                    0.7293999791145325,
                    0.2728842496871948,
                    0.24067020416259766,
                    0.6194577217102051,
                    0.23906898498535156,
                    0.2689201831817627,
                    0.3315250277519226,
                    0.3121612071990967,
                    0.2911812663078308,
                    0.3651570677757263,
                ],
                [
                    0.6299378871917725,
                    0.09539103507995605,
                    0.1973598599433899,
                    0.5072957277297974,
                    0.5695340633392334,
                    0.7761462330818176,
                    0.1487780213356018,
                    0.6595984697341919,
                    0.7841948866844177,
                    0.777630090713501,
                ],
                [
                    0.03428924083709717,
                    0.30919790267944336,
                    0.07021719217300415,
                    0.18359428644180298,
                    0.7784914374351501,
                    0.425340473651886,
                    0.7123556733131409,
                    0.20649683475494385,
                    0.5759799480438232,
                    0.1975710391998291,
                ],
                [
                    0.7499459981918335,
                    0.281310498714447,
                    0.3746204376220703,
                    0.06618434190750122,
                    0.5016517639160156,
                    0.9747400879859924,
                    0.7426890730857849,
                    0.23322951793670654,
                    0.5067243576049805,
                    0.44517576694488525,
                ],
                [
                    0.09746289253234863,
                    0.8920455574989319,
                    0.5080603361129761,
                    0.6052985191345215,
                    0.2980855107307434,
                    0.2660404443740845,
                    0.5824447870254517,
                    0.6848554611206055,
                    0.6121490001678467,
                    0.25902748107910156,
                ],
                [
                    0.9854488968849182,
                    0.42639780044555664,
                    0.193792462348938,
                    0.26614367961883545,
                    0.9922103881835938,
                    0.5000240802764893,
                    0.4321278929710388,
                    0.29191911220550537,
                    0.3689272999763489,
                    0.07888573408126831,
                ],
                [
                    0.10265827178955078,
                    0.792644739151001,
                    0.9277247190475464,
                    0.9771502017974854,
                    0.13902884721755981,
                    0.770431637763977,
                    0.19051671028137207,
                    0.7982801198959351,
                    0.8607771396636963,
                    0.8869354724884033,
                ],
                [
                    0.8600256443023682,
                    0.8127866387367249,
                    0.5097318291664124,
                    0.7297412157058716,
                    0.32111454010009766,
                    0.7177174091339111,
                    0.3392990231513977,
                    0.4916043281555176,
                    0.06481057405471802,
                    0.3692626953125,
                ],
                [
                    0.23706352710723877,
                    0.33133959770202637,
                    0.18070673942565918,
                    0.050277888774871826,
                    0.532558262348175,
                    0.8244895935058594,
                    0.9553747177124023,
                    0.7917770743370056,
                    0.24083131551742554,
                    0.005495131015777588,
                ],
                [
                    0.6896569132804871,
                    0.7801569700241089,
                    0.07074397802352905,
                    0.6792930364608765,
                    0.9227386116981506,
                    0.5302882790565491,
                    0.19877058267593384,
                    0.9099381566047668,
                    0.7135079503059387,
                    0.831100583076477,
                ],
            ],
            [
                [
                    0.1618572473526001,
                    0.7909727692604065,
                    0.15846318006515503,
                    0.9947471618652344,
                    0.2881501317024231,
                    0.8012835383415222,
                    0.6001207828521729,
                    0.6325052380561829,
                    0.42332249879837036,
                    0.7053676843643188,
                ],
                [
                    0.2916140556335449,
                    0.028710365295410156,
                    0.30789846181869507,
                    0.891769289970398,
                    0.36836516857147217,
                    0.6571592092514038,
                    0.31513679027557373,
                    0.8750746250152588,
                    0.7992451190948486,
                    0.6765068173408508,
                ],
                [
                    0.2444191575050354,
                    0.09143507480621338,
                    0.5188246965408325,
                    0.2066711187362671,
                    0.9110968708992004,
                    0.0195121169090271,
                    0.7234341502189636,
                    0.9984570145606995,
                    0.7504141926765442,
                    0.6704893708229065,
                ],
                [
                    0.018926680088043213,
                    0.9809466004371643,
                    0.414476215839386,
                    0.03279578685760498,
                    0.9935814142227173,
                    0.2965346574783325,
                    0.4646261930465698,
                    0.957639753818512,
                    0.15339964628219604,
                    0.1462550163269043,
                ],
                [
                    0.5813086628913879,
                    0.4330730438232422,
                    0.6151708960533142,
                    0.08064734935760498,
                    0.5149533152580261,
                    0.2776201367378235,
                    0.25419557094573975,
                    0.042181551456451416,
                    0.7651091814041138,
                    0.596318244934082,
                ],
                [
                    0.07727837562561035,
                    0.8967759609222412,
                    0.6508104205131531,
                    0.5927816033363342,
                    0.2064318060874939,
                    0.5754022598266602,
                    0.9817700982093811,
                    0.8429422378540039,
                    0.11056488752365112,
                    0.9564105868339539,
                ],
                [
                    0.5387548804283142,
                    0.7404825687408447,
                    0.8883381485939026,
                    0.9262545704841614,
                    0.11023259162902832,
                    0.9378319382667542,
                    0.16041254997253418,
                    0.5374830365180969,
                    0.15061819553375244,
                    0.39038336277008057,
                ],
                [
                    0.4772786498069763,
                    0.44018232822418213,
                    0.4210120439529419,
                    0.5394352674484253,
                    0.9932093620300293,
                    0.7905057668685913,
                    0.7797349691390991,
                    0.7001237273216248,
                    0.8870905637741089,
                    0.47692549228668213,
                ],
                [
                    0.5397561192512512,
                    0.6028985381126404,
                    0.06393474340438843,
                    0.09722155332565308,
                    0.5613006949424744,
                    0.3043748736381531,
                    0.4908251166343689,
                    0.3852705955505371,
                    0.5778313875198364,
                    0.8253077864646912,
                ],
                [
                    0.3341790437698364,
                    0.9004303216934204,
                    0.8947808742523193,
                    0.11625093221664429,
                    0.11388689279556274,
                    0.09546256065368652,
                    0.22598987817764282,
                    0.30536186695098877,
                    0.4623652696609497,
                    0.378403902053833,
                ],
                [
                    0.2473757266998291,
                    0.34115320444107056,
                    0.31912773847579956,
                    0.990519106388092,
                    0.314685583114624,
                    0.14199954271316528,
                    0.7078487873077393,
                    0.471119225025177,
                    0.882781982421875,
                    0.8124163150787354,
                ],
                [
                    0.9593644142150879,
                    0.13382023572921753,
                    0.8214316964149475,
                    0.9196193814277649,
                    0.2530842423439026,
                    0.959589958190918,
                    0.8748214840888977,
                    0.5054755806922913,
                    0.7410762310028076,
                    0.3251892328262329,
                ],
                [
                    0.06390810012817383,
                    0.6263900399208069,
                    0.6490626335144043,
                    0.17322051525115967,
                    0.742499828338623,
                    0.07288867235183716,
                    0.9303120374679565,
                    0.9841951727867126,
                    0.6361292004585266,
                    0.1862856149673462,
                ],
                [
                    0.7433356046676636,
                    0.5852078795433044,
                    0.6359593868255615,
                    0.6643266677856445,
                    0.8806777596473694,
                    0.28508204221725464,
                    0.3875274658203125,
                    0.6363529562950134,
                    0.5544805526733398,
                    0.9031888246536255,
                ],
                [
                    0.2373807430267334,
                    0.4817916750907898,
                    0.5934265851974487,
                    0.36720550060272217,
                    0.8408583402633667,
                    0.5546907782554626,
                    0.03788501024246216,
                    0.4458320736885071,
                    0.27322155237197876,
                    0.5485855937004089,
                ],
                [
                    0.44189202785491943,
                    0.004032909870147705,
                    0.4088873267173767,
                    0.4521103501319885,
                    0.35256075859069824,
                    0.9593902230262756,
                    0.3909004330635071,
                    0.8212085962295532,
                    0.6238588690757751,
                    0.0779334306716919,
                ],
                [
                    0.6174930334091187,
                    0.9143677949905396,
                    0.1729496717453003,
                    0.1768125295639038,
                    0.9894245266914368,
                    0.9017549753189087,
                    0.22105300426483154,
                    0.8008725047111511,
                    0.4360339641571045,
                    0.007035315036773682,
                ],
                [
                    0.5375667214393616,
                    0.6615470051765442,
                    0.35001957416534424,
                    0.6739417314529419,
                    0.07244956493377686,
                    0.8465079665184021,
                    0.926267147064209,
                    0.7757333517074585,
                    0.5847456455230713,
                    0.6646744608879089,
                ],
                [
                    0.13822609186172485,
                    0.37506330013275146,
                    0.45226621627807617,
                    0.2217569351196289,
                    0.13068997859954834,
                    0.8363087773323059,
                    0.8393226265907288,
                    0.045905888080596924,
                    0.6591059565544128,
                    0.7034010887145996,
                ],
                [
                    0.9749841690063477,
                    0.7892768383026123,
                    0.9596683382987976,
                    0.3363051414489746,
                    0.850193202495575,
                    0.9067006707191467,
                    0.027835965156555176,
                    0.09864664077758789,
                    0.6012027263641357,
                    0.7730188965797424,
                ],
                [
                    0.2515934705734253,
                    0.555067241191864,
                    0.4992741346359253,
                    0.6265538334846497,
                    0.2313252091407776,
                    0.7820194959640503,
                    0.8325046896934509,
                    0.153070867061615,
                    0.5048437118530273,
                    0.5013872981071472,
                ],
                [
                    0.6605578660964966,
                    0.9657922387123108,
                    0.6466317176818848,
                    0.38638901710510254,
                    0.9490664601325989,
                    0.3097335696220398,
                    0.3548141121864319,
                    0.5341376662254333,
                    0.11924558877944946,
                    0.5544086694717407,
                ],
            ],
            [
                [
                    0.1607622504234314,
                    0.5514103174209595,
                    0.5479037761688232,
                    0.5692103505134583,
                    0.07835221290588379,
                    0.025107860565185547,
                    0.7300586700439453,
                    0.9287979602813721,
                    0.05631381273269653,
                    0.685197114944458,
                ],
                [
                    0.13193923234939575,
                    0.5313456654548645,
                    0.9651788473129272,
                    0.8793095946311951,
                    0.13443011045455933,
                    0.8092859387397766,
                    0.7611585855484009,
                    0.49923306703567505,
                    0.9843633770942688,
                    0.3014124035835266,
                ],
                [
                    0.3836420774459839,
                    0.24729293584823608,
                    0.5719484090805054,
                    0.6323933601379395,
                    0.5398401021957397,
                    0.2186814546585083,
                    0.27491676807403564,
                    0.6700762510299683,
                    0.06158679723739624,
                    0.4221327304840088,
                ],
                [
                    0.48892420530319214,
                    0.2974180579185486,
                    0.6819590330123901,
                    0.5322268605232239,
                    0.8510323166847229,
                    0.4555942416191101,
                    0.1844307780265808,
                    0.8532758951187134,
                    0.5698243975639343,
                    0.35680091381073,
                ],
                [
                    0.17044860124588013,
                    0.6171944737434387,
                    0.023123741149902344,
                    0.6316888928413391,
                    0.747222363948822,
                    0.061399757862091064,
                    0.17266380786895752,
                    0.1405370831489563,
                    0.9202532768249512,
                    0.9250603318214417,
                ],
                [
                    0.53130042552948,
                    0.9694029092788696,
                    0.3328480124473572,
                    0.014588892459869385,
                    0.6746474504470825,
                    0.6771342754364014,
                    0.9901911616325378,
                    0.49985527992248535,
                    0.883198082447052,
                    0.8064818978309631,
                ],
                [
                    0.8618844151496887,
                    0.003833949565887451,
                    0.9117289781570435,
                    0.07377356290817261,
                    0.9482555389404297,
                    0.47927969694137573,
                    0.056891441345214844,
                    0.6390463709831238,
                    0.39822661876678467,
                    0.0509033203125,
                ],
                [
                    0.318730890750885,
                    0.5515525937080383,
                    0.8894233107566833,
                    0.3462851643562317,
                    0.7969839572906494,
                    0.5626142621040344,
                    0.516853928565979,
                    0.5956724882125854,
                    0.17186564207077026,
                    0.08440089225769043,
                ],
                [
                    0.34289419651031494,
                    0.03407299518585205,
                    0.26682472229003906,
                    0.5230029225349426,
                    0.17069536447525024,
                    0.292602002620697,
                    0.410156786441803,
                    0.4423983097076416,
                    0.2239927053451538,
                    0.5240254998207092,
                ],
                [
                    0.4298197627067566,
                    0.6429978013038635,
                    0.5225837230682373,
                    0.2503151297569275,
                    0.327858030796051,
                    0.49423712491989136,
                    0.18800735473632812,
                    0.5391424894332886,
                    0.46469712257385254,
                    0.6939892768859863,
                ],
                [
                    0.6183328628540039,
                    0.8741917610168457,
                    0.48351728916168213,
                    0.1305474042892456,
                    0.7235044836997986,
                    0.1620810627937317,
                    0.43127381801605225,
                    0.3380986452102661,
                    0.3102777600288391,
                    0.3150080442428589,
                ],
                [
                    0.9594602584838867,
                    0.7862284183502197,
                    0.6385686993598938,
                    0.9694783091545105,
                    0.04688900709152222,
                    0.5806837677955627,
                    0.8200882077217102,
                    0.8321449756622314,
                    0.10207313299179077,
                    0.6779447793960571,
                ],
                [
                    0.21515703201293945,
                    0.48046308755874634,
                    0.39566487073898315,
                    0.08251774311065674,
                    0.023042798042297363,
                    0.171051025390625,
                    0.7268852591514587,
                    0.7287177443504333,
                    0.06511813402175903,
                    0.31222885847091675,
                ],
                [
                    0.5081672072410583,
                    0.06770873069763184,
                    0.7817272543907166,
                    0.9528661966323853,
                    0.5884308815002441,
                    0.1284925937652588,
                    0.6165931820869446,
                    0.6815068125724792,
                    0.895921528339386,
                    0.23396503925323486,
                ],
                [
                    0.05204510688781738,
                    0.7196753025054932,
                    0.5311281681060791,
                    0.3370867967605591,
                    0.2904888391494751,
                    0.2421920895576477,
                    0.9047484993934631,
                    0.4137304425239563,
                    0.8606035113334656,
                    0.9463248252868652,
                ],
                [
                    0.563338041305542,
                    0.6065087914466858,
                    0.46594762802124023,
                    0.8434076905250549,
                    0.04945605993270874,
                    0.6988415122032166,
                    0.41853559017181396,
                    0.7283081412315369,
                    0.4977729916572571,
                    0.31486696004867554,
                ],
                [
                    0.446025013923645,
                    0.7699964046478271,
                    0.15273505449295044,
                    0.18395042419433594,
                    0.38800179958343506,
                    0.3186377286911011,
                    0.6964195966720581,
                    0.8364849090576172,
                    0.44645071029663086,
                    0.9727869033813477,
                ],
                [
                    0.2910900115966797,
                    0.21942031383514404,
                    0.27615296840667725,
                    0.15551382303237915,
                    0.14953309297561646,
                    0.05449223518371582,
                    0.056860387325286865,
                    0.6304993033409119,
                    0.8049269914627075,
                    0.9694236516952515,
                ],
                [
                    0.9258986711502075,
                    0.47120314836502075,
                    0.5970233082771301,
                    0.20084011554718018,
                    0.6932605504989624,
                    0.02057945728302002,
                    0.7358364462852478,
                    0.5917077660560608,
                    0.6536521315574646,
                    0.6830741763114929,
                ],
                [
                    0.27044761180877686,
                    0.9290531873703003,
                    0.73862624168396,
                    0.8284473419189453,
                    0.5660392642021179,
                    0.8139932751655579,
                    0.8365005254745483,
                    0.7266174554824829,
                    0.8808843493461609,
                    0.40931105613708496,
                ],
                [
                    0.8287680745124817,
                    0.6151995658874512,
                    0.8008480072021484,
                    0.9869992733001709,
                    0.6132185459136963,
                    0.3144165277481079,
                    0.4502519369125366,
                    0.6407642364501953,
                    0.5843046307563782,
                    0.3634149432182312,
                ],
                [
                    0.8917592167854309,
                    0.8004036545753479,
                    0.18942314386367798,
                    0.4592592716217041,
                    0.4520031213760376,
                    0.1866346001625061,
                    0.5729274749755859,
                    0.3465035557746887,
                    0.2418692708015442,
                    0.33922648429870605,
                ],
            ],
        ]
    )
    assert hidden_state.shape == (7, 22, 10)
    return {
        "hidden_state": hidden_state,
        "start_indices": start_indices,
        "end_indices": end_indices,
    }


def test_pool_cls(inputs):
    pooler = pool_cls
    output = pooler(**inputs)
    assert output is not None
    batch_size = inputs["hidden_state"].shape[0]
    hidden_size = inputs["hidden_state"].shape[-1]
    assert output.shape == (batch_size, hidden_size)
    torch.testing.assert_close(output, inputs["hidden_state"][:, 0, :])


def test_at_index_pooler(inputs):
    pooler = AtIndexPooler(input_dim=inputs["hidden_state"].shape[-1], num_indices=2)
    pooler_inputs = {"hidden_state": inputs["hidden_state"], "indices": inputs["start_indices"]}
    output = pooler(**pooler_inputs)
    assert output is not None
    batch_size = inputs["hidden_state"].shape[0]
    hidden_size = inputs["hidden_state"].shape[-1]
    # times num_indices (=2) due to concat
    assert output.shape == (batch_size, hidden_size * 2)
    torch.testing.assert_close(
        output,
        torch.tensor(
            [
                [
                    0.26963168382644653,
                    0.4413635730743408,
                    0.2969208359718323,
                    0.831685483455658,
                    0.10531491041183472,
                    0.26949483156204224,
                    0.3588126301765442,
                    0.19936376810073853,
                    0.5471915602684021,
                    0.006160438060760498,
                    0.21366488933563232,
                    0.6249018311500549,
                    0.43400341272354126,
                    0.13705700635910034,
                    0.5117283463478088,
                    0.15845924615859985,
                    0.07580167055130005,
                    0.2246686816215515,
                    0.06239396333694458,
                    0.1816309690475464,
                ],
                [
                    0.7399514317512512,
                    0.003641068935394287,
                    0.8103999495506287,
                    0.8741125464439392,
                    0.9728531837463379,
                    0.3820602297782898,
                    0.08917903900146484,
                    0.6124151349067688,
                    0.7762136459350586,
                    0.0023456215858459473,
                    0.637805163860321,
                    0.7739548683166504,
                    0.8800601959228516,
                    0.778437077999115,
                    0.004249513149261475,
                    0.5443443059921265,
                    0.8028765320777893,
                    0.45378726720809937,
                    0.20536041259765625,
                    0.9766699075698853,
                ],
                [
                    0.6495527625083923,
                    0.6720788478851318,
                    0.6151418685913086,
                    0.5078304409980774,
                    0.46363377571105957,
                    0.5068720579147339,
                    0.686712384223938,
                    0.964885413646698,
                    0.3704204559326172,
                    0.28864210844039917,
                    0.8181312084197998,
                    0.20143800973892212,
                    0.17288941144943237,
                    0.9363465905189514,
                    0.6768587231636047,
                    0.5132838487625122,
                    0.5676660537719727,
                    0.09815162420272827,
                    0.3330572843551636,
                    0.9813090562820435,
                ],
                [
                    0.8020546436309814,
                    0.4762613773345947,
                    0.06195652484893799,
                    0.22487705945968628,
                    0.1381239891052246,
                    0.7479812502861023,
                    0.1647258996963501,
                    0.4583408832550049,
                    0.6078779101371765,
                    0.22580265998840332,
                    0.691117525100708,
                    0.7006223201751709,
                    0.2008509635925293,
                    0.2808019518852234,
                    0.42452293634414673,
                    0.40856003761291504,
                    0.15737581253051758,
                    0.5411924719810486,
                    0.5496940016746521,
                    0.43668949604034424,
                ],
                [
                    0.9668692350387573,
                    0.2950131297111511,
                    0.14229488372802734,
                    0.22017812728881836,
                    0.36137717962265015,
                    0.26275062561035156,
                    0.24053412675857544,
                    0.701972246170044,
                    0.5849688649177551,
                    0.3399692177772522,
                    0.6299378871917725,
                    0.09539103507995605,
                    0.1973598599433899,
                    0.5072957277297974,
                    0.5695340633392334,
                    0.7761462330818176,
                    0.1487780213356018,
                    0.6595984697341919,
                    0.7841948866844177,
                    0.777630090713501,
                ],
                [
                    0.2373807430267334,
                    0.4817916750907898,
                    0.5934265851974487,
                    0.36720550060272217,
                    0.8408583402633667,
                    0.5546907782554626,
                    0.03788501024246216,
                    0.4458320736885071,
                    0.27322155237197876,
                    0.5485855937004089,
                    0.13822609186172485,
                    0.37506330013275146,
                    0.45226621627807617,
                    0.2217569351196289,
                    0.13068997859954834,
                    0.8363087773323059,
                    0.8393226265907288,
                    0.045905888080596924,
                    0.6591059565544128,
                    0.7034010887145996,
                ],
                [
                    0.9258986711502075,
                    0.47120314836502075,
                    0.5970233082771301,
                    0.20084011554718018,
                    0.6932605504989624,
                    0.02057945728302002,
                    0.7358364462852478,
                    0.5917077660560608,
                    0.6536521315574646,
                    0.6830741763114929,
                    0.05204510688781738,
                    0.7196753025054932,
                    0.5311281681060791,
                    0.3370867967605591,
                    0.2904888391494751,
                    0.2421920895576477,
                    0.9047484993934631,
                    0.4137304425239563,
                    0.8606035113334656,
                    0.9463248252868652,
                ],
            ]
        ),
    )


def test_at_index_pooler_with_offset(inputs):
    pooler = AtIndexPooler(input_dim=inputs["hidden_state"].shape[-1], num_indices=2, offset=-1)
    pooler_inputs = {"hidden_state": inputs["hidden_state"], "indices": inputs["start_indices"]}
    output = pooler(**pooler_inputs)
    assert output is not None
    batch_size = inputs["hidden_state"].shape[0]
    hidden_size = inputs["hidden_state"].shape[-1]
    # times num_indices (=2) due to concat
    assert output.shape == (batch_size, hidden_size * 2)
    torch.testing.assert_close(
        output,
        torch.tensor(
            [
                [
                    0.9345980882644653,
                    0.5935796499252319,
                    0.8694044351577759,
                    0.5677152872085571,
                    0.7410940527915955,
                    0.42940449714660645,
                    0.8854429125785828,
                    0.5739044547080994,
                    0.2665800452232361,
                    0.6274491548538208,
                    0.6057037711143494,
                    0.3725206255912781,
                    0.7980347275733948,
                    0.8399046063423157,
                    0.13741332292556763,
                    0.2330659031867981,
                    0.9578309655189514,
                    0.3312837481498718,
                    0.3227418065071106,
                    0.016202688217163086,
                ],
                [
                    0.8572163581848145,
                    0.1164739727973938,
                    0.8595983982086182,
                    0.2636241912841797,
                    0.6855345964431763,
                    0.9695573449134827,
                    0.4294840693473816,
                    0.4961332678794861,
                    0.38488471508026123,
                    0.08250772953033447,
                    0.4564777612686157,
                    0.3817083239555359,
                    0.2464839220046997,
                    0.05428081750869751,
                    0.09582149982452393,
                    0.23226916790008545,
                    0.9829188585281372,
                    0.258492648601532,
                    0.16423600912094116,
                    0.6211971044540405,
                ],
                [
                    0.7573983073234558,
                    0.30579549074172974,
                    0.20571684837341309,
                    0.5674465298652649,
                    0.20528340339660645,
                    0.17446929216384888,
                    0.760625958442688,
                    0.4160076975822449,
                    0.9568924903869629,
                    0.9863913059234619,
                    0.23052096366882324,
                    0.7612895369529724,
                    0.02678602933883667,
                    0.3066003918647766,
                    0.40259063243865967,
                    0.07512485980987549,
                    0.18205583095550537,
                    0.418390691280365,
                    0.879382312297821,
                    0.9828271269798279,
                ],
                [
                    0.744289755821228,
                    0.9410263895988464,
                    0.21586304903030396,
                    0.25309550762176514,
                    0.355430543422699,
                    0.5253631472587585,
                    0.8000994920730591,
                    0.21456867456436157,
                    0.7503269910812378,
                    0.3208093047142029,
                    0.2501947283744812,
                    0.3799319863319397,
                    0.3647148609161377,
                    0.17417055368423462,
                    0.009367704391479492,
                    0.7819257974624634,
                    0.6328370571136475,
                    0.03169959783554077,
                    0.1781865954399109,
                    0.9941840171813965,
                ],
                [
                    0.08671927452087402,
                    0.6343306303024292,
                    0.19783639907836914,
                    0.5181831121444702,
                    0.98748779296875,
                    0.3460923433303833,
                    0.3424041271209717,
                    0.8016564249992371,
                    0.31617337465286255,
                    0.4570612907409668,
                    0.7293999791145325,
                    0.2728842496871948,
                    0.24067020416259766,
                    0.6194577217102051,
                    0.23906898498535156,
                    0.2689201831817627,
                    0.3315250277519226,
                    0.3121612071990967,
                    0.2911812663078308,
                    0.3651570677757263,
                ],
                [
                    0.7433356046676636,
                    0.5852078795433044,
                    0.6359593868255615,
                    0.6643266677856445,
                    0.8806777596473694,
                    0.28508204221725464,
                    0.3875274658203125,
                    0.6363529562950134,
                    0.5544805526733398,
                    0.9031888246536255,
                    0.5375667214393616,
                    0.6615470051765442,
                    0.35001957416534424,
                    0.6739417314529419,
                    0.07244956493377686,
                    0.8465079665184021,
                    0.926267147064209,
                    0.7757333517074585,
                    0.5847456455230713,
                    0.6646744608879089,
                ],
                [
                    0.2910900115966797,
                    0.21942031383514404,
                    0.27615296840667725,
                    0.15551382303237915,
                    0.14953309297561646,
                    0.05449223518371582,
                    0.056860387325286865,
                    0.6304993033409119,
                    0.8049269914627075,
                    0.9694236516952515,
                    0.5081672072410583,
                    0.06770873069763184,
                    0.7817272543907166,
                    0.9528661966323853,
                    0.5884308815002441,
                    0.1284925937652588,
                    0.6165931820869446,
                    0.6815068125724792,
                    0.895921528339386,
                    0.23396503925323486,
                ],
            ]
        ),
    )


def test_argument_wrapped_pooler(inputs):
    class DummyPooler(Module):
        def __init__(self, input_dim: int, **kwargs):
            super().__init__(**kwargs)
            self.input_dim = input_dim

        def forward(self, x, **kwargs):
            return x[:, 0]

        @property
        def output_dim(self) -> int:
            return self.input_dim

    hidden_dim = inputs["hidden_state"].shape[-1]
    pooler = ArgumentWrappedPooler(
        pooler=DummyPooler(input_dim=hidden_dim), argument_mapping={"x": "hidden_state"}
    )
    output = pooler(**inputs)
    assert output is not None
    batch_size = inputs["hidden_state"].shape[0]
    hidden_size = inputs["hidden_state"].shape[-1]
    assert output.shape == (batch_size, hidden_size)
    torch.testing.assert_close(output, inputs["hidden_state"][:, 0, :])


def test_span_max_pooler(inputs):
    pooler = SpanMaxPooler(input_dim=inputs["hidden_state"].shape[-1], num_indices=2)
    output = pooler(**inputs)
    assert output is not None
    batch_size = inputs["hidden_state"].shape[0]
    hidden_size = inputs["hidden_state"].shape[-1]
    # times num_indices (=2) due to concat
    assert output.shape == (batch_size, hidden_size * 2)
    torch.testing.assert_close(
        output,
        torch.tensor(
            [
                [
                    0.951554536819458,
                    0.4413635730743408,
                    0.8860136866569519,
                    0.9464110732078552,
                    0.7890297770500183,
                    0.8089749813079834,
                    0.788632333278656,
                    0.9039816856384277,
                    0.8913041353225708,
                    0.34231340885162354,
                    0.21366488933563232,
                    0.6249018311500549,
                    0.43400341272354126,
                    0.13705700635910034,
                    0.5117283463478088,
                    0.15845924615859985,
                    0.07580167055130005,
                    0.2246686816215515,
                    0.06239396333694458,
                    0.1816309690475464,
                ],
                [
                    0.7399514317512512,
                    0.39394378662109375,
                    0.8103999495506287,
                    0.8741125464439392,
                    0.9728531837463379,
                    0.9192535877227783,
                    0.2999064326286316,
                    0.9102537631988525,
                    0.9191656112670898,
                    0.5406306385993958,
                    0.637805163860321,
                    0.7739548683166504,
                    0.8800601959228516,
                    0.778437077999115,
                    0.004249513149261475,
                    0.5443443059921265,
                    0.8028765320777893,
                    0.45378726720809937,
                    0.20536041259765625,
                    0.9766699075698853,
                ],
                [
                    0.6495527625083923,
                    0.8127392530441284,
                    0.6556223630905151,
                    0.8732241988182068,
                    0.8909887075424194,
                    0.7295627593994141,
                    0.9356598258018494,
                    0.964885413646698,
                    0.8771833777427673,
                    0.5729957222938538,
                    0.8181312084197998,
                    0.20143800973892212,
                    0.17288941144943237,
                    0.9363465905189514,
                    0.6768587231636047,
                    0.5132838487625122,
                    0.5676660537719727,
                    0.09815162420272827,
                    0.3330572843551636,
                    0.9813090562820435,
                ],
                [
                    0.8020546436309814,
                    0.4762613773345947,
                    0.06195652484893799,
                    0.22487705945968628,
                    0.1381239891052246,
                    0.7479812502861023,
                    0.1647258996963501,
                    0.4583408832550049,
                    0.6078779101371765,
                    0.22580265998840332,
                    0.691117525100708,
                    0.7006223201751709,
                    0.2008509635925293,
                    0.2808019518852234,
                    0.42452293634414673,
                    0.40856003761291504,
                    0.15737581253051758,
                    0.5411924719810486,
                    0.5496940016746521,
                    0.43668949604034424,
                ],
                [
                    0.9668692350387573,
                    0.5031309127807617,
                    0.8919203281402588,
                    0.7654821276664734,
                    0.7866955995559692,
                    0.932830810546875,
                    0.6548683643341064,
                    0.701972246170044,
                    0.9130488038063049,
                    0.7086918354034424,
                    0.6299378871917725,
                    0.09539103507995605,
                    0.1973598599433899,
                    0.5072957277297974,
                    0.5695340633392334,
                    0.7761462330818176,
                    0.1487780213356018,
                    0.6595984697341919,
                    0.7841948866844177,
                    0.777630090713501,
                ],
                [
                    0.2373807430267334,
                    0.4817916750907898,
                    0.5934265851974487,
                    0.36720550060272217,
                    0.8408583402633667,
                    0.5546907782554626,
                    0.03788501024246216,
                    0.4458320736885071,
                    0.27322155237197876,
                    0.5485855937004089,
                    0.13822609186172485,
                    0.37506330013275146,
                    0.45226621627807617,
                    0.2217569351196289,
                    0.13068997859954834,
                    0.8363087773323059,
                    0.8393226265907288,
                    0.045905888080596924,
                    0.6591059565544128,
                    0.7034010887145996,
                ],
                [
                    0.9258986711502075,
                    0.47120314836502075,
                    0.5970233082771301,
                    0.20084011554718018,
                    0.6932605504989624,
                    0.02057945728302002,
                    0.7358364462852478,
                    0.5917077660560608,
                    0.6536521315574646,
                    0.6830741763114929,
                    0.05204510688781738,
                    0.7196753025054932,
                    0.5311281681060791,
                    0.3370867967605591,
                    0.2904888391494751,
                    0.2421920895576477,
                    0.9047484993934631,
                    0.4137304425239563,
                    0.8606035113334656,
                    0.9463248252868652,
                ],
            ]
        ),
    )
